# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#

defaults: &defaults
  docker:
    - image: circleci/node:9.10
  environment:
    LIGHTHOUSE_CHROMIUM_PATH: ./scripts/chrome-linux/chrome

version: 2
jobs:
  install:
    <<: *defaults
    steps:
      - checkout
      - setup_remote_docker

      # Download and cache dependencies
      - restore_cache:
          keys:
          - react-pwa-dependencies-{{ checksum "package.json" }}
          # fallback to using the latest cache if no exact match is found
          - react-pwa-dependencies-

      - run: yarn
      # Persist the specified paths (build) into the workspace for use
      - persist_to_workspace:
          root: .
          paths: .

  build:
    <<: *defaults
    environment:
      NODE_ENV: production
    steps:
      - attach_workspace:
          at: .
      # Build/bundle frontend & node code
      - run: yarn build
      - persist_to_workspace:
          root: .
          paths: .

  # test:
  #   <<: *defaults
  #   steps:
  #     - attach_workspace:
  #         at: .
  #     # Run tests
  #     - run: yarn test


  lint:
    <<: *defaults
    steps:
      - attach_workspace:
          at: .
      # Run tests
      - run: yarn lint

  # Test pwa performances
  lighthouse:
    <<: *defaults
    steps:
      - attach_workspace:
          at: .
      # Install latest Chrome
      - run: bash scripts/download-chrome.sh
      # Install old version of Chromium to have most of the deps
      - run: sudo apt update
      - run: sudo apt install chromium libatk-bridge2.0-0 libgtk-3-0
      # Run the benchmark
      - run: yarn lighthouse:script
      # Create badges and copy all in artifacts
      - run: yarn lighthouse:badges
      - store_artifacts:
          path: .reports
          destination: badges

  deploy:
    <<: *defaults
    steps:
      - attach_workspace:
          at: .
      # Install AWS's CLI
      - run:
          name: Install AWS CLI
          command: |
            sudo apt-get -y install python-dev
            curl "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip" -o "awscli-bundle.zip"
            unzip awscli-bundle.zip
            sudo ./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws

      # Build the Docker container
      - run:
          name: Build the Docker container
          command: |
            docker build -t 711655675495.dkr.ecr.us-east-1.amazonaws.com/react-pwa:latest .

      # Push the built containers to AWS ECR
      - run:
          name: Push the Docker container
          command: |
            eval $(aws ecr get-login --no-include-email --region us-east-1)
            docker push 711655675495.dkr.ecr.us-east-1.amazonaws.com/react-pwa:latest

      # Trigger a AWS ECS service update that will force the cluster to
      # re-pull the Docker container(s), to get the 'latest' tagged version
      - run:
          name: Trigger a ECS deploy
          command: |
            aws ecs update-service --region us-east-1 --cluster react-pwa-cluster --service react-pwa-service --force-new-deployment

workflows:
  version: 2
  build-then-test-and-deploy:
    jobs:
      - install
      # - chrome-download
      - build:
          requires:
            - install
      # - test:
      #     requires:
      #       - install
      - lint:
          requires:
            - install
      - lighthouse:
          requires:
            - build
      - deploy:
          requires:
            - lighthouse
            # - test
          filters:
            branches:
              only: master

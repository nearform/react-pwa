# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#

version: 2
jobs:
  build:
    docker:
      - image: circleci/node:10.1.0-browsers
    steps:
      - checkout # Checkout repository
      - run:
          name: Update NPM
          command: 'sudo npm install -g npm@latest'
      - restore_cache: # special step to restore the dependency cache
          key: react-pwa-dependency-cache-{{ checksum "package.json" }}
      - run:
          name: Install Dependencies
          command: npm install
      - save_cache: # special step to save the dependency cache
          key: react-pwa-dependency-cache-{{ checksum "package.json" }}
          paths:
            - ./node_modules
      - run: # builds the application
          name: Build the application
          environment:
            NODE_ENV: production
          command: npm run build
      - run: # lint the code
          name: Run code linter
          command: npm run lint
      - run: # Run lighthouse
          name: Run Lighthouse on the application
          environment:
            NODE_ENV: production
            command: npm run lighthouse
      - store_artifacts:
          path: coverage/badges
  # deploy:
  #   requires:
  #     - build
  #   filters:
  #     branches:
  #       only: master
  #   steps:
  #     - run: # Install AWS CLI
  #       name: Install AWS CLI
  #       command: |
  #         sudo apt-get -y install python-dev
  #         curl "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip" -o "awscli-bundle.zip"
  #         unzip awscli-bundle.zip
  #         sudo ./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws
  #     - run: # Build the Docker container
  #         name: Build the Docker container
  #         command: |
  #           docker build -t 711655675495.dkr.ecr.us-east-1.amazonaws.com/react-pwa:latest .
  #     - run: # Push the built containers to AWS ECR
  #         name: Push the Docker container
  #         command: |
  #           eval $(aws ecr get-login --no-include-email --region us-east-1)
  #           docker push 711655675495.dkr.ecr.us-east-1.amazonaws.com/react-pwa:latest
  #     - run: # Trigger a AWS ECS service update that will force the cluster to re-pull the Docker container(s), to get the 'latest' tagged version
  #         name: Trigger a ECS deploy
  #         command: |
  #           aws ecs update-service --region us-east-1 --cluster react-pwa-cluster --service react-pwa-service --force-new-deployment